parameters:
  azConnection: ""
  AzSubscription: ""
  environmentKey: ""
  regionKey: ""
  appName: ""
  location: "Australia East"
  buildRef: ""
  resourceGroupName: ""
steps:
- task: AzureCLI@2
  displayName: 'Azure CLI: Copy Template to Storage'
  inputs:
    azureSubscription: '${{parameters.azConnection}}'
    scriptType: pscore
    scriptPath: '$(Pipeline.Workspace)/$(ArtifactName)/${{parameters.appName}}/scripts/Upload-AzureStorageBlob.ps1'
    arguments: '-EnvironmentKey ${{parameters.environmentKey}} -SourcePath $(Pipeline.Workspace)/$(ArtifactName) -Region ${{parameters.regionKey}} -DestinationContainer $(ArtifactName)-$(Build.BuildId)'
- task: AzureResourceGroupDeployment@3
  displayName: "Validate ${{parameters.appName}} in ${{parameters.resourceGroupName}}"
  inputs:
    deploymentScope: 'Resource Group'
    azureResourceManagerConnection: '${{parameters.azConnection}}'
    subscriptionId: '${{parameters.AzSubscription}}'
    action: 'Create Or Update Resource Group'
    resourceGroupName: '${{parameters.resourceGroupName}}'
    location: '${{parameters.Location}}'
    templateLocation: 'Linked artifact'
    csmFile:  $(Pipeline.Workspace)/$(ArtifactName)/${{parameters.appName}}/${{parameters.appName}}.azuredeploy.json
    csmParametersFile: '$(Pipeline.Workspace)/$(ArtifactName)/${{parameters.appName}}/parameters/${{parameters.environmentKey}}.azuredeploy.parameters.json'
    overrideParameters: "-_artifactsLocation $(storageURI)${{parameters.appName}} -_artifactsLocationSasToken $(sasToken) -templateVersion ${{ parameters.buildRef }}"
    deploymentMode: 'Validation'
- task: AzureResourceGroupDeployment@3
  displayName: "Deploy ${{parameters.appName}} in ${{parameters.resourceGroupName}}"
  inputs:
    deploymentScope: 'Resource Group'
    azureResourceManagerConnection: '${{parameters.azConnection}}'
    subscriptionId: '${{parameters.AzSubscription}}'
    action: 'Create Or Update Resource Group'
    resourceGroupName: '${{parameters.resourceGroupName}}'
    location: '${{parameters.Location}}'
    templateLocation: 'Linked artifact'
    csmFile:  $(Pipeline.Workspace)/$(ArtifactName)/${{parameters.appName}}/${{parameters.appName}}.azuredeploy.json
    csmParametersFile: '$(Pipeline.Workspace)/$(ArtifactName)/${{parameters.appName}}/parameters/${{parameters.environmentKey}}.azuredeploy.parameters.json'
    overrideParameters: "-_artifactsLocation $(storageURI)${{parameters.appName}} -_artifactsLocationSasToken $(sasToken) -templateVersion ${{ parameters.buildRef }}"
    deploymentMode: 'Complete'
 
