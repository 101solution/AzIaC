parameters:
  azConnection: ""
  AzSubscription: ""
  environmentKey: ""
  regionKey: ""
  environmentKeyRg: ""
  regionKeyRg: ""
  appName: ""
  location: "Australia East"
  buildRef: ""
steps:
- task: AzureCLI@2
  displayName: 'Azure CLI: Copy Template to Storage'
  inputs:
    azureSubscription: '${{parameters.azConnection}}'
    scriptType: pscore
    scriptPath: '$(Pipeline.Workspace)/$(ArtifactName)/SharedServices/scripts/Upload-AzureStorageBlob.ps1'
    arguments: '-EnvironmentKey ${{parameters.environmentKey}} -SourcePath $(Pipeline.Workspace)/$(ArtifactName) -Region ${{parameters.regionKey}} -DestinationContainer $(ArtifactName)-$(Build.BuildId)'
- task: AzureResourceGroupDeployment@3
  displayName: Validate Shared Services 
  inputs:
    deploymentScope: 'Resource Group'
    azureResourceManagerConnection: '${{parameters.azConnection}}'
    subscriptionId: '${{parameters.AzSubscription}}'
    action: 'Create Or Update Resource Group'
    resourceGroupName: 'RACWA-${{parameters.regionKeyRg}}-ARG-${{parameters.environmentKeyRg}}-$(SharedServiceRGNumber)'
    location: '{{parameters.location}}'
    templateLocation: 'Linked artifact'
    csmFile:  $(Pipeline.Workspace)/$(ArtifactName)/SharedServices/SharedService.azuredeploy.json
    csmParametersFile: '$(Pipeline.Workspace)/$(ArtifactName)/SharedServices/parameters/${{parameters.environmentKey}}.azuredeploy.parameters.json'
    overrideParameters: "-_artifactsLocation $(storageURI)${{parameters.appName}} -_artifactsLocationSasToken $(sasToken) -templateVersion ${{ parameters.buildRef }}"
    deploymentMode: 'Validation'
- task: AzureResourceGroupDeployment@3
  displayName: Deploy Shared Services 
  inputs:
    deploymentScope: 'Resource Group'
    azureResourceManagerConnection: '${{parameters.azConnection}}'
    subscriptionId: '${{parameters.AzSubscription}}'
    action: 'Create Or Update Resource Group'
    resourceGroupName: 'RACWA-${{parameters.regionKeyRg}}-ARG-${{parameters.environmentKeyRg}}-$(SharedServiceRGNumber)'
    location: '{{parameters.location}}'
    templateLocation: 'Linked artifact'
    csmFile:  $(Pipeline.Workspace)/$(ArtifactName)/SharedServices/SharedService.azuredeploy.json
    csmParametersFile: '$(Pipeline.Workspace)/$(ArtifactName)/SharedServices/parameters/${{parameters.environmentKey}}.azuredeploy.parameters.json'
    overrideParameters: "-_artifactsLocation $(storageURI)${{parameters.appName}} -_artifactsLocationSasToken $(sasToken) -templateVersion ${{ parameters.buildRef }}"
    deploymentMode: 'Incremental'
- task: AzurePowerShell@5
  condition: and(eq('${{ parameters.environmentKey }}', 'npe'), eq('${{ parameters.regionKey }}', 'dcc'))
  displayName: 'Enable Static Content Site'
  inputs:
    azureSubscription: '${{parameters.azConnection}}'
    ScriptPath: '$(Pipeline.Workspace)/$(ArtifactName)/SharedServices/scripts/Enable-StaticSite.ps1'
    ScriptArguments: '-Region dcc -EnvironmentKey npe'
    azurePowerShellVersion: LatestVersion      
